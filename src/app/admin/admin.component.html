<div class="admin-page">
  <!-- Header -->
  <header class="admin-header">
    <div class="header-content">
      <h1>üõ†Ô∏è Panel de Administrador</h1>
      <button class="btn-logout" (click)="logout()">
        <i class="fa-solid fa-sign-out-alt"></i> Cerrar sesi√≥n
      </button>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="admin-tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'productos'"
      (click)="setActiveTab('productos')">
      <i class="fa-solid fa-box"></i> Productos
    </button>
    <button 
      class="tab" 
      [class.active]="activeTab === 'estadisticas'"
      (click)="setActiveTab('estadisticas')">
      <i class="fa-solid fa-chart-bar"></i> Estad√≠sticas
    </button>
  </nav>

  <div class="admin-content">
    <!-- Tab: Productos -->
    <div *ngIf="activeTab === 'productos'" class="tab-content">
      <div class="content-header">
        <h2>Gesti√≥n de Productos</h2>
        <button class="btn-add" (click)="openAddModal()">
          <i class="fa-solid fa-plus"></i> Agregar Producto
        </button>
      </div>

      <div *ngIf="loading" class="loading">Cargando productos...</div>

      <div class="products-table" *ngIf="!loading">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Producto</th>
              <th>Categor√≠a</th>
              <th>Precio (S/)</th>
              <th>Stock</th>
              <th>Ventas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of products">
              <td>{{ p.id }}</td>
              <td class="product-name">{{ p.name }}</td>
              <td>{{ getCategoryName(p.id_categoria) }}</td>
              <td>
                <input 
                  type="number" 
                  [(ngModel)]="p.price" 
                  class="input-small"
                  min="0"
                  step="0.01"
                />
              </td>
              <td>
                <input 
                  type="number" 
                  [(ngModel)]="p.stock" 
                  class="input-small"
                  min="0"
                />
              </td>
              <td class="sales-cell">{{ p.sales || 0 }}</td>
              <td class="actions-cell">
                <button class="btn-save" (click)="updateProduct(p)">
                  <i class="fa-solid fa-save"></i>
                </button>
                <button class="btn-update-img" (click)="updateProductImage(p)">
                  <i class="fa-solid fa-image"></i>
                </button>
                <button class="btn-delete" (click)="deleteProduct(p)">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Estad√≠sticas -->
    <div *ngIf="activeTab === 'estadisticas'" class="tab-content">
      <h2>üìä Dashboard de Estad√≠sticas</h2>

      <div *ngIf="loadingDashboard" class="loading">Cargando estad√≠sticas...</div>

      <div *ngIf="!loadingDashboard">
                <!-- Gr√°fico de Inventario por Categor√≠a -->
                <div class="dashboard-section" *ngIf="inventarioChartOption && inventarioChartOption.series">
                  <h3>üìä Inventario por Categor√≠a</h3>
                  <div class="chart-container">
                    <div echarts [options]="inventarioChartOption" class="echart-container"></div>
                  </div>
                </div>
        <!-- Indicadores de Inventario Serial Ideal -->
        <div class="dashboard-section">
          <h3>üì¶ Inventario: Indicadores Clave</h3>
          <ul class="inventario-list">
            <li *ngFor="let msg of inventarioMensajes">
              <i class="fa-solid fa-circle-info" style="color:#956C12;margin-right:8px;"></i>
              {{ msg }}
            </li>
            <li *ngIf="inventarioMensajes.length === 0">
              <i class="fa-solid fa-circle-info" style="color:#956C12;margin-right:8px;"></i>
              No hay alertas ni indicadores especiales de inventario.
            </li>
          </ul>
        </div>
        <!-- Resumen General -->
        <div class="dashboard-section" *ngIf="resumenGeneral">
          <h3>üìà Resumen General</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">
                <i class="fa-solid fa-shopping-cart"></i>
              </div>
              <div class="stat-info">
                <h3>Total Ventas</h3>
                <p class="stat-value">{{ resumenGeneral.totalVentas || 0 }}</p>
                <p class="stat-detail">unidades vendidas</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon green">
                <i class="fa-solid fa-dollar-sign"></i>
              </div>
              <div class="stat-info">
                <h3>Ingresos Totales</h3>
                <p class="stat-value">S/ {{ (resumenGeneral.totalIngresos || 0).toFixed(2) }}</p>
                <p class="stat-detail">en ventas</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon orange">
                <i class="fa-solid fa-box"></i>
              </div>
              <div class="stat-info">
                <h3>Total Compras</h3>
                <p class="stat-value">{{ resumenGeneral.totalCompras || 0 }}</p>
                <p class="stat-detail">unidades compradas</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon red">
                <i class="fa-solid fa-money-bill"></i>
              </div>
              <div class="stat-info">
                <h3>Gastos Totales</h3>
                <p class="stat-value">S/ {{ (resumenGeneral.totalGastos || 0).toFixed(2) }}</p>
                <p class="stat-detail">en compras</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Ventas por A√±o - Gr√°fico de Barras ECharts -->
        <div class="dashboard-section" *ngIf="ventasResumenAnio.length > 0">
          <h3>üìÖ Ventas por A√±o</h3>
          <div class="chart-container">
            <div echarts [options]="ventasAnioChartOption" class="echart-container"></div>
          </div>
        </div>

        <!-- Total en Dinero por A√±o - Gr√°fico de L√≠nea con √Årea -->
        <div class="dashboard-section" *ngIf="ventasTotalAnio.length > 0">
          <h3>üí∞ Total en Dinero por A√±o</h3>
          <div class="chart-container">
            <div echarts [options]="ventasTotalAnioChartOption" class="echart-container"></div>
          </div>
        </div>

        <!-- Ventas por Mes - Gr√°fico de Barras Verticales -->
        <div class="dashboard-section" *ngIf="ventasDelMes.length > 0">
          <h3>üìÜ Ventas por Mes</h3>
          <div class="filter-row">
            <label>
              A√±o:
              <select [(ngModel)]="anioSeleccionado" (change)="onAnioChange()">
                <option [value]="2024">2024</option>
                <option [value]="2025">2025</option>
                <option [value]="2026">2026</option>
              </select>
            </label>
          </div>
          <div class="chart-container">
            <div echarts [options]="ventasMesChartOption" class="echart-container"></div>
          </div>
        </div>

        <!-- Total en Dinero por Mes - Gr√°fico de Barras Horizontales -->
        <div class="dashboard-section" *ngIf="ventasTotalMes.length > 0">
          <h3>üíµ Total en Dinero por Mes ({{ anioSeleccionado }})</h3>
          <div class="chart-container">
            <div echarts [options]="ventasTotalMesChartOption" class="echart-container"></div>
          </div>
        </div>

        <!-- Categor√≠a M√°s Vendida - Gr√°fico de Dona (Donut Chart) -->
        <div class="dashboard-section" *ngIf="categoriaMasVendida.length > 0">
          <h3>üèÜ Categor√≠as M√°s Vendidas</h3>
          <div class="chart-container">
            <div echarts [options]="categoriasChartOption" class="echart-container"></div>
          </div>
        </div>

        <!-- Producto M√°s Vendido por Categor√≠a - Gr√°fico de Barras Horizontales -->
        <div class="dashboard-section">
          <h3>üéØ Productos M√°s Vendidos por Categor√≠a</h3>
          <div class="filter-row">
            <label>
              Categor√≠a:
              <select [(ngModel)]="categoriaSeleccionada" (change)="onCategoriaChange()">
                <option [value]="0">Selecciona una categor√≠a</option>
                <option *ngFor="let cat of categories" [value]="cat.id_categoria">
                  {{ cat.nombre_categoria }}
                </option>
              </select>
            </label>
          </div>
          <div class="chart-container" *ngIf="productosPorCategoria.length > 0">
            <div echarts [options]="productosChartOption" class="echart-container"></div>
          </div>
          <p class="empty-state" *ngIf="categoriaSeleccionada > 0 && productosPorCategoria.length === 0">
            No hay productos vendidos en esta categor√≠a
          </p>
        </div>

        <!-- Forma de Pago M√°s Usada - Gr√°fico Circular (Pie Chart) -->
        <div class="dashboard-section" *ngIf="formaPagoMasUsada.length > 0">
          <h3>üí≥ Formas de Pago M√°s Usadas</h3>
          <div class="chart-container">
            <div echarts [options]="pagosChartOption" class="echart-container"></div>
          </div>
        </div>

                <!-- Gr√°fico de Inventario por Categor√≠a (DEBAJO de Formas de Pago) -->
                <div class="dashboard-section" *ngIf="inventarioChartOption && inventarioChartOption.series">
                  <h3>üìä Inventario por Categor√≠a</h3>
                  <div class="chart-container">
                    <div echarts [options]="inventarioChartOption" class="echart-container"></div>
                  </div>
                </div>

        <!-- Mensaje cuando no hay datos -->
        <div class="dashboard-section" *ngIf="!loadingDashboard && ventasResumenAnio.length === 0 && ventasTotalAnio.length === 0">
          <div class="empty-state">
            <i class="fa-solid fa-chart-line" style="font-size: 3rem; color: #9ca3af; margin-bottom: 16px;"></i>
            <h3>No hay datos disponibles</h3>
            <p>Los endpoints del dashboard no est√°n respondiendo o no hay datos en el sistema.</p>
            <p>Aseg√∫rate de que el backend est√© corriendo en <strong>http://localhost:8080</strong></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Agregar Producto -->
  <div class="modal-backdrop" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Agregar Nuevo Producto</h3>
        <button class="close-btn" (click)="closeAddModal()">&times;</button>
      </div>
      <div class="modal-body">
        <label>
          Nombre del producto *
          <input type="text" [(ngModel)]="newProduct.nombre" placeholder="Ej: Tomate" required />
        </label>
        
        <label>
          C√≥digo de barras
          <input type="text" [(ngModel)]="newProduct.codigo_barras" placeholder="7750101000011" />
        </label>
        
        <label>
          Categor√≠a *
          <select [(ngModel)]="newProduct.id_categoria" required>
            <option [value]="0">Selecciona una categor√≠a</option>
            <option *ngFor="let cat of categories" [value]="cat.id_categoria">
              {{ cat.nombre_categoria }}
            </option>
          </select>
        </label>
        
        <div class="form-row">
          <label>
            Precio (S/) *
            <input type="number" [(ngModel)]="newProduct.precio" min="0" step="0.01" required />
          </label>
          
          <label>
            Stock *
            <input type="number" [(ngModel)]="newProduct.stock" min="0" required />
          </label>
        </div>
        
        <label>
          Imagen URL (Imgur, etc.)
          <input type="text" [(ngModel)]="newProduct.imagen" placeholder="https://i.imgur.com/ejemplo.jpg" />
          <small style="color: #666; font-size: 0.9em;">Puedes subir una imagen a Imgur y pegar la URL aqu√≠</small>
        </label>
        
        <div class="form-row">
          <label>
            Lote
            <input type="text" [(ngModel)]="newProduct.lote" placeholder="L-MAS-001" />
          </label>
          
          <label>
            Fecha de Ingreso
            <input type="date" [(ngModel)]="newProduct.fecha_registro" />
          </label>
        </div>
        
        <label>
          Fecha de Vencimiento
          <input type="date" [(ngModel)]="newProduct.fecha_vencimiento" />
        </label>
        
        <label>
          Descripci√≥n
          <textarea [(ngModel)]="newProduct.descripcion" rows="3" placeholder="Descripci√≥n del producto"></textarea>
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeAddModal()">Cancelar</button>
        <button class="btn-submit" (click)="addProduct()">Agregar Producto</button>
      </div>
    </div>
  </div>
</div>
